# Lesson 12: DPDK Ring HTSæ¨¡å¼

## è¯¾ç¨‹ç›®æ ‡

å­¦ä¹ DPDK Ringçš„HTSï¼ˆHead-Tail Syncï¼‰åŒæ­¥æ¨¡å¼ï¼Œç†è§£å…¶é€‚ç”¨åœºæ™¯ï¼ŒæŒæ¡Peek APIçš„ä½¿ç”¨æ–¹æ³•ã€‚

---

## çŸ¥è¯†ç‚¹

### 1. HTSæ¨¡å¼ç®€ä»‹

**HTSï¼ˆHead-Tail Syncï¼‰**ï¼šå¤´å°¾åŒæ­¥æ¨¡å¼ï¼Œä¸€ç§åºåˆ—åŒ–çš„å¤šç”Ÿäº§è€…/å¤šæ¶ˆè´¹è€…åŒæ­¥æ–¹å¼ã€‚

**æ ¸å¿ƒç‰¹ç‚¹**ï¼š
- åŒä¸€æ—¶åˆ»åªå…è®¸ä¸€ä¸ªçº¿ç¨‹æ“ä½œRingï¼ˆåƒæ’é˜Ÿï¼‰
- é¿å…MP/MCæ¨¡å¼ä¸­çš„tailç­‰å¾…é—®é¢˜
- ç‰¹åˆ«é€‚åˆè™šæ‹Ÿæœº/å®¹å™¨ç¯å¢ƒ

### 2. é€‚ç”¨åœºæ™¯

âœ… **è™šæ‹Ÿæœº/å®¹å™¨ç¯å¢ƒ** - èµ„æºè¢«è°ƒåº¦å™¨åŠ¨æ€åˆ†é…
âœ… **è¿‡åº¦æäº¤åœºæ™¯** - çº¿ç¨‹æ•° > CPUæ ¸å¿ƒæ•°
âœ… **éœ€è¦Peek API** - å…ˆçœ‹å†…å®¹å†å†³å®šæ˜¯å¦å–å‡º
âœ… **éœ€è¦ç¨³å®šå»¶è¿Ÿ** - æ›´å¯é¢„æµ‹çš„å»¶è¿Ÿè¡¨ç°

### 3. æ€§èƒ½ç‰¹ç‚¹

| åœºæ™¯ | HTS vs MP/MC |
|------|--------------|
| ç‰©ç†æœº | æ…¢10-20% |
| è™šæ‹Ÿæœº/å®¹å™¨ | **å¿«30-50%** |

### 4. Peek API

**Peek API**ï¼šHTSæ¨¡å¼ç‹¬æœ‰çš„ç‰¹æ€§ï¼Œå…è®¸"å…ˆçœ‹å†å–"ã€‚

**ä½¿ç”¨åœºæ™¯**ï¼š
- æ¡ä»¶è¿‡æ»¤æ¶ˆæ¯
- ä¼˜å…ˆçº§é˜Ÿåˆ—å®ç°
- æ ¹æ®æ¶ˆæ¯å†…å®¹å†³å®šæ˜¯å¦å¤„ç†

---

## ä»£ç ç»“æ„

### ç›®å½•ç»“æ„

```
12-hts-ring/
â”œâ”€â”€ CMakeLists.txt      # CMakeæ„å»ºé…ç½®
â””â”€â”€ hts_ring.c          # HTS Ringç¤ºä¾‹ä»£ç 
```

### æµ‹è¯•å†…å®¹

ç¤ºä¾‹ä»£ç åŒ…å«4ä¸ªæµ‹è¯•ï¼š

1. **Test 1**: HTSæ€§èƒ½æµ‹è¯•
2. **Test 2**: HTS vs MP/MCæ€§èƒ½å¯¹æ¯”
3. **Test 3**: Peek APIæ¼”ç¤ºï¼ˆHTSç‹¬æœ‰ï¼‰
4. **Test 4**: å¤šçº¿ç¨‹HTSæµ‹è¯•

---

## æ ¸å¿ƒAPI

### åˆ›å»ºHTS Ring

```c
#include <rte_ring.h>

/* åˆ›å»ºHTSæ¨¡å¼Ring */
struct rte_ring *ring = rte_ring_create(
    "hts_ring",
    1024,                    // Ringå¤§å°ï¼ˆå¿…é¡»æ˜¯2çš„å¹‚ï¼‰
    rte_socket_id(),         // NUMA socket
    RING_F_MP_HTS_ENQ |      // HTSç”Ÿäº§è€…
    RING_F_MC_HTS_DEQ        // HTSæ¶ˆè´¹è€…
);
```

### ä½¿ç”¨é€šç”¨API

HTS Ringä½¿ç”¨æ ‡å‡†çš„Ring APIï¼š

```c
/* å…¥é˜Ÿ */
unsigned sent = rte_ring_enqueue_burst(ring, objs, n, NULL);

/* å‡ºé˜Ÿ */
unsigned received = rte_ring_dequeue_burst(ring, objs, n, NULL);
```

### Peek APIï¼ˆä¸¤é˜¶æ®µæ“ä½œï¼‰

```c
void *obj;

/* é˜¶æ®µ1ï¼šPeek - æŸ¥çœ‹é˜Ÿå¤´å…ƒç´ ï¼ˆä¸ç§»é™¤ï¼‰ */
uint32_t n = rte_ring_dequeue_bulk_start(ring, &obj, 1, NULL);

if (n != 0) {
    /* é˜¶æ®µ2ï¼šå†³å®šæ˜¯å¦å–å‡º */
    if (should_accept(obj)) {
        /* ç¡®è®¤å‡ºé˜Ÿ */
        rte_ring_dequeue_finish(ring, 1);
        // å¤„ç†obj...
    } else {
        /* å–æ¶ˆå‡ºé˜Ÿï¼ˆå…ƒç´ ä¿ç•™åœ¨Ringä¸­ï¼‰ */
        rte_ring_dequeue_finish(ring, 0);
    }
}
```

---

## ç¼–è¯‘å’Œè¿è¡Œ

### ç¼–è¯‘

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•
mkdir -p build
cd build
cmake ..
make hts_ring
```

### è¿è¡Œ

```bash
# åŸºç¡€è¿è¡Œï¼ˆå•æ ¸ï¼‰
sudo ./bin/hts_ring -l 0 --no-pci

# å¤šæ ¸è¿è¡Œï¼ˆæ¨èï¼Œç”¨äºæµ‹è¯•4ï¼‰
sudo ./bin/hts_ring -l 0-3 --no-pci
```

### é¢„æœŸè¾“å‡º

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   DPDK Ring HTS Mode Demo                     â•‘
â•‘   (Head-Tail Sync Mode)                       â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   Test 1: HTS Mode Performance               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ“ Created HTS ring (size=1024)

Performance:
  Operations: 1000000
  Time: 0.082 seconds
  Throughput: 12.20 Mpps

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   Test 2: HTS vs MP/MC Comparison            â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ“ Created HTS and MP/MC rings

Testing HTS mode...
Testing MP/MC mode...

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Mode     â”‚   Mpps   â”‚  Relative    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   HTS      â”‚  12.20   â”‚    100.0%    â”‚
â”‚   MP/MC    â”‚  14.35   â”‚    117.6%    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ’¡ HTS is 15.0% slower (normal on physical machines)

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   Test 3: Peek API (HTS Only)                â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ“ Created HTS ring for Peek API test
âœ“ Enqueued 20 messages with different priorities

Using Peek API to filter messages (only accept priority 0 and 1):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  [Peek #1] Seq=0, Priority=0 â†’ âœ“ Accept
  [Peek #2] Seq=1, Priority=1 â†’ âœ“ Accept
  [Peek #3] Seq=2, Priority=2 â†’ âœ— Reject (stop)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Peek API Results:
  Peeked:   3 messages
  Accepted: 2 messages (priority 0-1)
  Rejected: 1 messages (priority 2)
  Remaining in ring: 17 messages

ğŸ’¡ Peek API allows conditional dequeue:
   - Look at the message first
   - Decide whether to take it or leave it
   - Only supported by HTS and SP/SC modes

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   Test 4: Multi-thread HTS Test              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ“ Created HTS ring for multi-thread test
  Available lcores: 4

  [Lcore 1] Worker started
  [Lcore 2] Worker started
  [Lcore 3] Worker started
  [Lcore 1] Worker finished (enqueued 100)
  [Lcore 2] Worker finished (enqueued 100)
  [Lcore 3] Worker finished (enqueued 100)

âœ“ All 3 workers completed
  Final ring count: 0

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   All Tests Completed                          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Key Takeaways:
  1. HTS is 10-20% slower than MP/MC on physical machines
  2. HTS is faster in VM/container environments (overcommit)
  3. Peek API is unique to HTS and SP/SC modes
  4. HTS provides more predictable latency
```

---

## æµ‹è¯•è§£æ

### Test 1: HTSæ€§èƒ½æµ‹è¯•

æµ‹è¯•HTSæ¨¡å¼çš„åŸºæœ¬æ€§èƒ½ï¼Œé€šè¿‡100ä¸‡æ¬¡å…¥é˜Ÿ/å‡ºé˜Ÿæ“ä½œæµ‹é‡ååé‡ã€‚

**å…³é”®ä»£ç **ï¼š
```c
for (i = 0; i < TEST_COUNT / 32; i++) {
    rte_ring_enqueue_burst(hts_ring, objs, 32, NULL);
    rte_ring_dequeue_burst(hts_ring, objs, 32, NULL);
}
```

### Test 2: HTS vs MP/MCå¯¹æ¯”

å¯¹æ¯”HTSå’ŒMP/MCæ¨¡å¼çš„æ€§èƒ½å·®å¼‚ã€‚

**é¢„æœŸç»“æœ**ï¼š
- ç‰©ç†æœºï¼šMP/MCå¿«10-20%
- è™šæ‹Ÿæœº/å®¹å™¨ï¼šHTSå¿«30-50%

### Test 3: Peek APIæ¼”ç¤º

æ¼”ç¤ºPeek APIçš„æ¡ä»¶å¼å‡ºé˜ŸåŠŸèƒ½ã€‚

**åœºæ™¯**ï¼šæ ¹æ®æ¶ˆæ¯ä¼˜å…ˆçº§å†³å®šæ˜¯å¦å¤„ç†
- Priority 0-1ï¼šæ¥å—å¹¶å¤„ç†
- Priority 2ï¼šæ‹’ç»å¹¶åœæ­¢

**æ ¸å¿ƒé€»è¾‘**ï¼š
```c
ret = rte_ring_dequeue_bulk_start(ring, &obj, 1, NULL);
if (msg->priority <= 1) {
    rte_ring_dequeue_finish(ring, 1);  // ç¡®è®¤å–å‡º
} else {
    rte_ring_dequeue_finish(ring, 0);  // å–æ¶ˆï¼Œä¿ç•™åœ¨Ringä¸­
}
```

### Test 4: å¤šçº¿ç¨‹HTSæµ‹è¯•

å¤šä¸ªworkerçº¿ç¨‹åŒæ—¶å¯¹HTS Ringè¿›è¡Œå…¥é˜Ÿ/å‡ºé˜Ÿæ“ä½œï¼ŒéªŒè¯HTSçš„åŒæ­¥æ­£ç¡®æ€§ã€‚

---

## å¸¸è§é—®é¢˜

### Q1: HTSæ¯”MP/MCæ…¢ï¼Œä¸ºä»€ä¹ˆè¿˜è¦ç”¨ï¼Ÿ

**ç­”**ï¼šåœ¨ç‰¹å®šåœºæ™¯ä¸‹HTSæ›´ä¼˜ï¼š
- **è™šæ‹Ÿæœº/å®¹å™¨**ï¼šHTSæ›´å¿«ï¼ˆé¿å…tailç­‰å¾…ï¼‰
- **éœ€è¦Peek API**ï¼šåªæœ‰HTSå’ŒSP/SCæ”¯æŒ
- **å»¶è¿Ÿæ•æ„Ÿ**ï¼šHTSå»¶è¿Ÿæ›´å¯é¢„æµ‹

### Q2: Peek APIçš„å…¸å‹åº”ç”¨ï¼Ÿ

**ç­”**ï¼š
1. **æ¶ˆæ¯è¿‡æ»¤**ï¼šè·³è¿‡ä¸æ„Ÿå…´è¶£çš„æ¶ˆæ¯
2. **ä¼˜å…ˆçº§é˜Ÿåˆ—**ï¼šå®ç°å¤æ‚çš„è°ƒåº¦ç­–ç•¥
3. **æ¡ä»¶å¤„ç†**ï¼šæ ¹æ®ç³»ç»ŸçŠ¶æ€å†³å®šæ˜¯å¦å¤„ç†
4. **æµé‡æ§åˆ¶**ï¼šæ ¹æ®è´Ÿè½½åŠ¨æ€è°ƒæ•´æ¥æ”¶

### Q3: å¦‚ä½•é€‰æ‹©Ringæ¨¡å¼ï¼Ÿ

**å†³ç­–æ ‘**ï¼š
```
æ˜¯å¦å•ç”Ÿäº§è€…å•æ¶ˆè´¹è€…ï¼Ÿ
  â””â”€> æ˜¯ï¼šSP/SCï¼ˆæœ€å¿«ï¼‰

æ˜¯å¦éœ€è¦Peek APIï¼Ÿ
  â””â”€> æ˜¯ï¼šHTS

æ˜¯å¦è¿è¡Œåœ¨è™šæ‹Ÿæœº/å®¹å™¨ï¼Ÿ
  â””â”€> æ˜¯ï¼šHTS
  â””â”€> å¦ï¼šMP/MCï¼ˆç‰©ç†æœºæœ€å¿«ï¼‰
```

### Q4: Peek APIçš„æ€§èƒ½å¼€é”€ï¼Ÿ

**ç­”**ï¼š
- Peekæœ¬èº«å¼€é”€å¾ˆå°
- å¦‚æœé¢‘ç¹"çœ‹äº†åˆä¸å–"ä¼šå½±å“æ€§èƒ½
- å»ºè®®ï¼šå¦‚æœå¤§éƒ¨åˆ†æ¶ˆæ¯éƒ½ä¼šå¤„ç†ï¼Œç›´æ¥ç”¨`dequeue`

### Q5: å¯ä»¥æ··åˆä½¿ç”¨ä¸åŒæ¨¡å¼å—ï¼Ÿ

**ç­”**ï¼šä¸èƒ½ã€‚Ringåˆ›å»ºæ—¶ç¡®å®šæ¨¡å¼ï¼Œä¹‹åä¸èƒ½æ›´æ”¹ã€‚

---

## å®è·µç»ƒä¹ 

### ç»ƒä¹ 1ï¼šå®ç°ä¼˜å…ˆçº§é˜Ÿåˆ—

ä½¿ç”¨Peek APIå®ç°ä¸€ä¸ªç®€å•çš„ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼š
- åªå¤„ç†é«˜ä¼˜å…ˆçº§æ¶ˆæ¯ï¼ˆpriority < 5ï¼‰
- ä½ä¼˜å…ˆçº§æ¶ˆæ¯ç•™åœ¨é˜Ÿåˆ—ä¸­

### ç»ƒä¹ 2ï¼šæ€§èƒ½æµ‹è¯•

åœ¨è™šæ‹Ÿæœº/å®¹å™¨ç¯å¢ƒä¸­è¿è¡Œæµ‹è¯•ï¼Œè§‚å¯ŸHTS vs MP/MCæ€§èƒ½å·®å¼‚ã€‚

### ç»ƒä¹ 3ï¼šæ¡ä»¶è¿‡æ»¤

å®ç°ä¸€ä¸ªæ¶ˆæ¯è¿‡æ»¤å™¨ï¼š
- ä½¿ç”¨Peek APIæŸ¥çœ‹æ¶ˆæ¯
- æ ¹æ®æ¶ˆæ¯ç±»å‹å†³å®šæ˜¯å¦å¤„ç†
- ç»Ÿè®¡accept/rejectæ¯”ä¾‹

---

## æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **HTSç‰¹ç‚¹**ï¼šåŒä¸€æ—¶åˆ»åªå…è®¸ä¸€ä¸ªçº¿ç¨‹æ“ä½œ
2. **é€‚ç”¨åœºæ™¯**ï¼šè™šæ‹Ÿæœº/å®¹å™¨ã€éœ€è¦Peek API
3. **æ€§èƒ½æƒè¡¡**ï¼šç‰©ç†æœºæ…¢10-20%ï¼Œè™šæ‹Ÿæœºå¿«30-50%
4. **Peek API**ï¼šHTSç‹¬æœ‰ï¼Œå®ç°æ¡ä»¶å¼å‡ºé˜Ÿ

### é€‰æ‹©å»ºè®®

| åœºæ™¯ | æ¨èæ¨¡å¼ |
|------|----------|
| å•ç”Ÿäº§è€…å•æ¶ˆè´¹è€… | SP/SC |
| ç‰©ç†æœºé«˜åå | MP/MC |
| è™šæ‹Ÿæœº/å®¹å™¨ | HTS |
| éœ€è¦Peek API | HTS |

---

## å‚è€ƒèµ„æº

- [DPDK Ring Library å®˜æ–¹æ–‡æ¡£](https://doc.dpdk.org/guides/prog_guide/ring_lib.html)
- [DPDK Ring HTS Guide](./DPDK-Ring-HTS-Guide.md)
- [Lesson 10: SP/SC Ring](./lesson10-ring-spsc-mpmc.md)
- [Lesson 11: MP/MC Ring](./lesson11-mp-mc-ring.md)

---

**ä¸‹ä¸€è¯¾é¢„å‘Š**ï¼šRTSæ¨¡å¼ï¼ˆRelaxed Tail Syncï¼‰- HTSçš„ä¼˜åŒ–ç‰ˆæœ¬
